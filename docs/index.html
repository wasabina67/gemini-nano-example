<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>gemini-nano-example</title>
    <style>
      body {
        font-family: sans-serif;
        max-width: 600px;
        margin: 40px auto;
        padding: 0 20px;
      }

      h1 {
        font-size: 1.5rem;
      }

      button {
        margin-top: 10px;
        padding: 5px;
        font-size: 0.8rem;
        cursor: pointer;
      }

      #status {
        margin: 20px 0;
        color: #666;
      }

      #prompt {
        width: 100%;
        padding: 10px;
        font-size: 1rem;
        box-sizing: border-box;
      }

      #response {
        margin-top: 20px;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 5px;
        white-space: pre-wrap;
        display: none;
      }

      #response.visible {
        display: block;
      }
    </style>
  </head>
  <body>
    <div>
      <h1>gemini-nano-example</h1>
      <div id="status">Checking...</div>
      <button id="init-model" style="display: none;">Initialize the model</button>
      <textarea id="prompt" rows="3" placeholder="Input here"></textarea>
      <button id="send">Send</button>
      <div id="response"></div>
    </div>
    <script>
      const lang = 'ja'; // 'en' or 'ja'
      const status = document.getElementById('status');
      const initModel = document.getElementById('init-model');
      let session = null;

      async function createSession() {
        status.textContent = 'Initializing model...';
        initModel.style.display = 'none';

        try {
          session = await LanguageModel.create({
            expectedInputs: [{ type: 'text', languages: [lang] }],
            expectedOutputs: [{ type: 'text', languages: [lang] }],
            monitor(m) {
              m.addEventListener('downloadprogress', (e) => {
                status.textContent = `Downloading now: ${Math.round(e.loaded * 100)}%`;
              });
            },
          });
          status.textContent = 'Ready';
        } catch (e) {
          status.textContent = `${e.message}`;
          initModel.style.display = 'inline';
        }
      }

      async function init() {
        try {
          const availability = await LanguageModel.availability({
            expectedInputs: [{ type: 'text', languages: [lang] }],
            expectedOutputs: [{ type: 'text', languages: [lang] }],
          });

          if (availability === 'unavailable') {
            status.textContent = 'Gemini Nano is not available';
            return;
          } else if (availability === 'available') {
            await createSession();
          } else {
            status.textContent = 'Model download required';
            initModel.style.display = 'inline';
            initModel.onclick = createSession;
          }
        } catch (e) {
          status.textContent = `${e.message}`;
        }
      }

      async function sendPrompt() {
        if (!session) return;
        const promptEl = document.getElementById('prompt');
        const prompt = promptEl.value.trim();
        if (!prompt) return;
        promptEl.disabled = true;

        const sendBtn = document.getElementById('send');
        sendBtn.disabled = true;

        const response = document.getElementById('response');
        response.textContent = 'Processing...';
        response.classList.add('visible');

        try {
          // prompt (non-streaming)
          // const result = await session.prompt(prompt);
          // response.textContent = result;

          // promptStreaming
          const stream = session.promptStreaming(prompt);
          response.textContent = '';
          for await (const chunk of stream) response.textContent += chunk;
        } catch (e) {
          response.textContent = `${e.message}`;
        } finally {
          promptEl.disabled = false;
          sendBtn.disabled = false;
        }
      }

      document.getElementById('send').onclick = sendPrompt;
      document.getElementById('prompt').onkeydown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendPrompt();
        }
      };

      init();
    </script>
  </body>
</html>
